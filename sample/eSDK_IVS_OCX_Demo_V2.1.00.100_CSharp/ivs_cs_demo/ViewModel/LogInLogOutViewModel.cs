#region 文件头注释
/*******************************************************************************
// 版权所有  2013 华为技术有限公司
// 程 序 集：ivs_cs_demo
// 文 件 名：LogInLogOutViewModel.cs
// 文件说明：登录、登出视图 
// 版    本：
// 创建人：  00206574
// 创建日期：2013-07-15
// 修改人： 
// 修改标识：
// 修改日期：
// 修改说明：
*******************************************************************************/
#endregion
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Windows.Input;
using System.Windows;
using System.ComponentModel;
using System.Globalization;

namespace ivs_cs_demo
{
   public class LogInLogOutViewModel
    {
       public ICommand InitCommand { get; set; }
       public ICommand GetVersionCommand { get; set; }
       public ICommand ReleaseCommand { get; set; }
       public ICommand LogInCommand { get; set; }
       public ICommand LogOutCommand { get; set; }
       public ICommand ModifyPasswordCommand { get; set; }

       public LogInLogOutControls logInLogOutControls { get; set; }
       public LogInLogOutViewModel(LogInLogOutControls window)
       {
           logInLogOutControls = window;

           InitCommand = new DelegateCommand(InitCommandProcess);
           GetVersionCommand = new DelegateCommand(GetVersionCommandProcess);
           ReleaseCommand = new DelegateCommand(ReleaseCommandProcess);

           LogInCommand = new DelegateCommand(LogInCommandProcess);
           LogOutCommand = new DelegateCommand(LogOutCommandProcess);
           ModifyPasswordCommand = new DelegateCommand(ModifyPasswordCommandProcess);
       }

       private void InitCommandProcess()//初始化
       {
           try
           {
             OcxHelper.MainWin.PlayOcx.Visibility = System.Windows.Visibility.Visible;
             int resultCode = OcxHelper.OCX.IVS_OCX_Cleanup();//释放
             resultCode = OcxHelper.OCX.IVS_OCX_Init();
             resultCode = OcxHelper.OCX.IVS_OCX_SetLanguage(CultureInfo.CurrentCulture.Name);
             resultCode = OcxHelper.OCX.IVS_OCX_ShowTitlebar(true);
             resultCode = OcxHelper.OCX.IVS_OCX_ShowToolbar(true);

             logInLogOutControls.eSDKCodeTextBlock.Text = @"int resultCode = OcxHelper.OCX.IVS_OCX_Init();";

             if (resultCode == 0)
             {
                 OcxHelper.MainWin.OperationInfo.Content =StringHelper.FindLanguageResource("Init") + StringHelper.FindLanguageResource("Success");
             }
             else
             {
                 OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource(resultCode.ToString());
             }
           }
           catch (Exception ex)
           {
               LogService.Error(ex.ToString());
               OcxHelper.MainWin.OperationInfo.Content = ex.ToString();
               return;
           }
       }
       private void GetVersionCommandProcess()//获取版本
       {
           try
           {
               int result = OcxHelper.OCX.IVS_OCX_GetVersion();
               string versionHex = Convert.ToString(result, 16);

               if (versionHex.Length == 7)
               {
                   versionHex = "0" + versionHex;
               }
               int mainVersion = Int32.Parse(versionHex.ToString().Substring(0, 2), System.Globalization.NumberStyles.HexNumber);
               int versionID = Int32.Parse(versionHex.ToString().Substring(2, 2), System.Globalization.NumberStyles.HexNumber);
               int modifyVersion = Int32.Parse(versionHex.ToString().Substring(4, 2), System.Globalization.NumberStyles.HexNumber);
               int reVersion = Int32.Parse(versionHex.ToString().Substring(6, 2), System.Globalization.NumberStyles.HexNumber);
               logInLogOutControls.Version.Text = mainVersion + "." + versionID + "." + modifyVersion + "." + reVersion;

               logInLogOutControls.eSDKCodeTextBlock.Text = @"int resultCode = OcxHelper.OCX.IVS_OCX_GetVersion();";

               OcxHelper.MainWin.OperationInfo.Content = logInLogOutControls.Version.Text;

           }
           catch (Exception ex)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
           {
               LogService.Error(ex.ToString());
               OcxHelper.MainWin.OperationInfo.Content = ex.ToString();
               return;
           }
       }
       private void ReleaseCommandProcess()//释放
       {
           try
           {
               logInLogOutControls.eSDKCodeTextBlock.Text = @"int resultCode = OcxHelper.OCX.IVS_OCX_Cleanup();";
               Application.Current.Dispatcher.BeginInvoke(new Action(() => { OcxHelper.OCX.IVS_OCX_Cleanup(); }),System.Windows.Threading.DispatcherPriority.Background);

               OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource("Release") + StringHelper.FindLanguageResource("Success");
               OcxHelper.MainWin.LogInfo.Content = string.Empty;
           }
           catch (Exception ex)
           {
               LogService.Error(ex.ToString());
               OcxHelper.MainWin.OperationInfo.Content = ex.ToString();
               return;
           }
       }

       private void LogInCommandProcess()//登录
       {
           try
           {
               int resultCode = OcxHelper.OCX.IVS_OCX_Login(logInLogOutControls.UserList.Text.ToString(), logInLogOutControls.PasswordTextBox.Password.ToString(),
                                           logInLogOutControls.ServeTextBox.Text.ToString(),logInLogOutControls.PortTextBox.Text.ToString(),0);
               logInLogOutControls.eSDKCodeTextBlock.Text = @"int resultCode = OcxHelper.OCX.IVS_OCX_Login(pUserName, pPWD, pServerIP, pPort, ulClientType);";
               OcxHelper.OCX.IVS_OCX_SetLanguage(CultureInfo.CurrentCulture.Name);
               if (resultCode == 0)
               {
                   OcxHelper.MainWin.OperationInfo.Content = logInLogOutControls.UserList.Text.ToString() + (CultureInfo.CurrentCulture.Name =="en-US"? " ":"") +StringHelper.FindLanguageResource("LogSuccess");
                   OcxHelper.MainWin.LogInfo.Content = logInLogOutControls.UserList.Text.ToString() + StringHelper.FindLanguageResource("LogIn");

                   UserEntity user = new UserEntity();
                   user.username = logInLogOutControls.UserList.Text.ToString();
                   user.userpassword = logInLogOutControls.PasswordTextBox.Password.ToString();
                   user.port = logInLogOutControls.PortTextBox.Text.ToString();
                   user.ip = logInLogOutControls.ServeTextBox.Text.ToString();

                   XmlHelper.AddUser(user);
               }
               else
               {
                   OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource(resultCode.ToString());
               }
           }
           catch (Exception ex)
           {
               LogService.Error(ex.ToString());
               OcxHelper.MainWin.OperationInfo.Content = ex.ToString();
               return;
           }
       }
       private void LogOutCommandProcess()//签出
       {
           try
           {
               int resultCode = OcxHelper.OCX.IVS_OCX_Logout();

               logInLogOutControls.eSDKCodeTextBlock.Text = @"int resultCode = OcxHelper.OCX.IVS_OCX_Logout();";
               if (resultCode == 0)
               {
                   OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource("LogOut") + StringHelper.FindLanguageResource("Success");
                   OcxHelper.MainWin.LogInfo.Content = string.Empty;
               }
               else
               {
                   OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource(resultCode.ToString());
               }
           }
           catch (Exception ex)
           {
               LogService.Error(ex.ToString());
               OcxHelper.MainWin.OperationInfo.Content = ex.ToString();
               return;
           }
       }
       private void ModifyPasswordCommandProcess()//修改密码
       {
           try
           {
               if (logInLogOutControls.ConfirmNewPassword.Password != logInLogOutControls.NewPassword.Password)
               {
                   OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource("PassWordError");
                   return;
               }
               int resultCode = OcxHelper.OCX.IVS_OCX_ChangePWD(logInLogOutControls.OldPassword.Password.ToString(), logInLogOutControls.NewPassword.Password.ToString());
               logInLogOutControls.eSDKCodeTextBlock.Text = @"int resultCode = OcxHelper.OCX.IVS_OCX_ChangePWD(pOldPWD, pNewPWD);";
               if (resultCode == 0)
               {
                   OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource("ModifyPassword") + StringHelper.FindLanguageResource("Success");
               }
               else
               {
                   OcxHelper.MainWin.OperationInfo.Content = StringHelper.FindLanguageResource(resultCode.ToString());
               }
           }
           catch (Exception ex)
           {
               LogService.Error(ex.ToString());
               OcxHelper.MainWin.OperationInfo.Content = ex.ToString();
               return;
           }
       }
    }
}
